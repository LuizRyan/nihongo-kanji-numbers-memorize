<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Treino de Números em Japonês</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #options button {
      transition: background 0.4s ease, color 0.4s ease;
    }
    #options button:hover {
      background: linear-gradient(to right, #c084fc, #a78bfa);
    }
    #lang-toggle {
      cursor: pointer;
      background-color: rgba(167, 139, 250, 0.85);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: 600;
      transition: background 0.3s ease;
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 1000;
      user-select: none;
    }
    #lang-toggle:hover {
      background-color: rgba(124, 58, 237, 0.9);
    }
    #dark-toggle {
      cursor: pointer;
      background-color: rgba(249, 115, 22, 0.35);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: 600;
      transition: background 0.3s ease;
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 1000;
      user-select: none;
    }
    #dark-toggle:hover {
      background-color: rgba(234, 88, 12, 0.7);
    }
    /* Modo Noturno */
    body.dark {
      background-color: #121212;
      color: #cccccc;
    }
    body.dark #app {
      background-color: #1e1e1e;
      color: #cccccc;
      box-shadow: none;
    }
    body.dark .bg-gray-200 {
      background-color: #2a2a2a !important;
      color: #ddd !important;
    }
    body.dark #translation, body.dark #jp-number {
      color: #fbbf24;
    }
    body.dark #feedback {
      color: inherit;
    }
    body.dark #score {
      color: #cccccc;
    }
    body.dark label, body.dark select, body.dark input[type="range"] {
      color: #cccccc;
      background-color: #2c2c2c;
      border-color: #444444;
    }
    body.dark select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    body.dark #options button {
      background-color: rgba(249, 115, 22, 0.35) !important;
      color: #fff !important;
    }
    body.dark #options button:hover {
      background: linear-gradient(to right, rgba(249, 115, 22, 0.6), rgba(234, 88, 12, 0.6)) !important;
    }

    /* Canvas para fogos */
    #fireworks-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 2000;
    }

    /* Posicionamento do volume no canto inferior direito */
    #volume-container {
      position: fixed;
      bottom: 12px;
      right: 12px;
      z-index: 1000;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    body.dark #volume-container {
      background-color: rgba(44, 44, 44, 0.9);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    #volume-label {
      font-weight: 600;
      white-space: nowrap; /* Impede que o texto quebre */
      color: #333;
    }

    body.dark #volume-label {
      color: #cccccc;
    }

    #volume-slider {
      width: 120px; /* Ajuste a largura conforme necessário */
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: #ddd;
      outline: none;
      border-radius: 4px;
      transition: background 0.2s ease;
    }

    body.dark #volume-slider {
      background: #555;
    }

    #volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #a78bfa;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    body.dark #volume-slider::-webkit-slider-thumb {
      background: #fbbf24;
    }

    #volume-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #a78bfa;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    body.dark #volume-slider::-moz-range-thumb {
      background: #fbbf24;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100 flex items-center justify-center p-4 relative">

  <button id="dark-toggle">Modo Noturno</button>
  <button id="lang-toggle">English</button>

  <div id="app" class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-md">

    <div class="flex justify-between mb-2">
      <div id="hint-symbol" class="text-xl">☥</div>
      <div id="score" class="text-sm font-semibold">Pontuação: <strong>0/0</strong></div>
    </div>

    <div class="bg-gray-200 rounded-xl p-6 text-center mb-4">
      <div id="translation" class="text-lg font-semibold text-gray-700 mb-2"></div>
      <div id="jp-number" class="text-6xl font-black">?</div>
    </div>

    <div id="options" class="grid grid-cols-2 gap-2 mb-4"></div>
    <p id="feedback" class="text-center text-lg font-medium"></p>

    <div class="mt-6">
      <label id="mode-label" class="block mb-1 font-semibold" for="mode">Modo:</label>
      <select id="mode" class="w-full p-2 border rounded-md mb-4">
        <option value="kanji">Contagem com Kanji (三つ)</option>
        <option value="normal">Numeral Normal (いち, に, さん)</option>
        <option value="ambos">Misto</option>
      </select>

      <div id="range-container">
        <label id="range-label" class="block mb-1 font-semibold" for="range-slider">Intervalo:</label>
        <input type="range" id="range-slider" min="10" max="100" step="10" value="10" class="w-full p-2 border rounded-md" />
        <div id="range-value" class="text-center mt-2 font-medium">1 - 10</div>
      </div>
    </div>
  </div>

  <div id="volume-container">
    <label id="volume-label" for="volume-slider">Volume:</label>
    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.5" />
  </div>

  <audio id="sound-correct" src="assets/correto-2.mp3" preload="auto"></audio>
  <audio id="sound-wrong" src="assets/erro.mp3" preload="auto"></audio>

  <canvas id="fireworks-canvas"></canvas>

  <script>
    // Textos
    const texts = {
      pt: {
        title: "Treino de Números em Japonês",
        score: "Pontuação",
        correct: "✅ Correto!",
        wrong: "❌ Errado! Correto:",
        modeLabel: "Modo:",
        modeOptions: [
          "Contagem com Kanji (三つ)",
          "Numeral Normal (いち, に, さん)",
          "Misto"
        ],
        rangeLabel: "Intervalo:",
        langToggle: "English",
        darkToggle: "Modo Noturno",
        darkToggleActive: "Modo Claro",
        volumeLabel: "Volume:"
      },
      en: {
        title: "Japanese Numbers Training",
        score: "Score",
        correct: "✅ Correct!",
        wrong: "❌ Wrong! Correct:",
        modeLabel: "Mode:",
        modeOptions: [
          "Counting with Kanji (三つ)",
          "Normal Numeral (ichi, ni, san)",
          "Mixed"
        ],
        rangeLabel: "Range:",
        langToggle: "Português",
        darkToggle: "Dark Mode",
        darkToggleActive: "Light Mode",
        volumeLabel: "Volume:"
      }
    };

    // Dados dos números
    const baseNumbers = [
      ["一", "いち"], ["二", "に"], ["三", "さん"], ["四", "よん"], ["五", "ご"],
      ["六", "ろく"], ["七", "なな"], ["八", "はち"], ["九", "きゅう"], ["十", "じゅう"]
    ];

    const extendedNumbers = [];
    for (let i = 1; i <= 100; i++) {
      let jp = "";
      let hira = "";
      if (i === 100) { 
        jp = "百";
        hira = "ひゃく"; // Hiragana correto
      } else if (i <= 10) {
        jp = baseNumbers[i - 1][0];
        hira = baseNumbers[i - 1][1];
      } else if (i < 20) {
        jp = "十" + (i % 10 !== 0 ? baseNumbers[(i % 10) - 1][0] : "");
        hira = "じゅう" + (i % 10 !== 0 ? baseNumbers[(i % 10) - 1][1] : "");
      } else if (i % 10 === 0) {
        jp = baseNumbers[Math.floor(i / 10) - 1][0] + "十";
        hira = baseNumbers[Math.floor(i / 10) - 1][1] + "じゅう";
      } else {
        jp = baseNumbers[Math.floor(i / 10) - 1][0] + "十" + baseNumbers[(i % 10) - 1][0];
        hira = baseNumbers[Math.floor(i / 10) - 1][1] + "じゅう" + baseNumbers[(i % 10) - 1][1];
      }
      extendedNumbers.push({ jp, hira, num: i });
    }

    const dataKanji = [
      { jp: "一つ", hira: "ひとつ", num: 1 },
      { jp: "二つ", hira: "ふたつ", num: 2 },
      { jp: "三つ", hira: "みっつ", num: 3 },
      { jp: "四つ", hira: "よっつ", num: 4 },
      { jp: "五つ", hira: "いつつ", num: 5 },
      { jp: "六つ", hira: "むっつ", num: 6 },
      { jp: "七つ", hira: "ななつ", num: 7 },
      { jp: "八つ", hira: "やっつ", num: 8 },
      { jp: "九つ", hira: "ここのつ", num: 9 },
      { jp: "十", hira: "とお", num: 10 }
    ];

    // Elementos DOM
    const jpNumberEl = document.getElementById("jp-number");
    const translationEl = document.getElementById("translation");
    const hintSymbolEl = document.getElementById("hint-symbol");
    const feedbackEl = document.getElementById("feedback");
    const scoreEl = document.getElementById("score");
    const optionsEl = document.getElementById("options");
    const rangeContainer = document.getElementById("range-container");
    const modeSelect = document.getElementById("mode");
    const rangeSlider = document.getElementById("range-slider"); 
    const rangeValueDisplay = document.getElementById("range-value"); 
    const modeLabel = document.getElementById("mode-label");
    const rangeLabel = document.getElementById("range-label");
    const langToggleBtn = document.getElementById("lang-toggle");
    const darkToggleBtn = document.getElementById("dark-toggle");
    const soundCorrect = document.getElementById("sound-correct");
    const soundWrong = document.getElementById("sound-wrong");
    const volumeSlider = document.getElementById("volume-slider");
    const volumeLabel = document.getElementById("volume-label");

    // Estado
    let currentLang = "pt";
    let darkMode = false;
    let current;
    let hits = 0;
    let total = 0;
    let used = [];
    let locked = false; 

    // Tenta tocar os sons uma vez na primeira interação para contornar políticas de autoplay
    document.addEventListener('DOMContentLoaded', () => {
        const tryPlaySounds = () => {
            soundCorrect.volume = volumeSlider.value;
            soundWrong.volume = volumeSlider.value;
            // Tenta tocar um som silencioso ou muito curto para 'ativar' o áudio
            soundCorrect.play().then(() => {
                soundCorrect.pause();
                soundCorrect.currentTime = 0;
                console.log("Sons pré-carregados e ativados.");
                document.removeEventListener('click', tryPlaySounds);
            }).catch(e => {
                console.warn("Não foi possível tocar sons automaticamente (provavelmente bloqueado pelo navegador).", e);
            });
        };
        // Adiciona um listener para a primeira interação do usuário
        document.addEventListener('click', tryPlaySounds, { once: true });
        document.addEventListener('keydown', tryPlaySounds, { once: true });
    });


    // Função para embaralhar
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // Obter pool de opções de acordo com modo e intervalo
    function getPool() {
      const mode = modeSelect.value;
      let pool = [];

      if (mode === "kanji") {
        pool = dataKanji;
        rangeContainer.style.display = "none"; 
      } else if (mode === "normal") {
        const range = parseInt(rangeSlider.value);
        pool = extendedNumbers.slice(0, range);
        rangeContainer.style.display = "block"; 
      } else { // Ambos
        pool = [...dataKanji, ...extendedNumbers]; 
        rangeContainer.style.display = "none"; 
      }

      return pool.map(item => {
        let tipo = "";
        if (mode === "ambos") {
          const isKanjiCounting = dataKanji.some(k => k.num === item.num && k.jp === item.jp);
          tipo = isKanjiCounting ? "⸸" : "☥"; 
        }
        return { ...item, tipo };
      });
    }

    // Atualiza o display do valor do slider de intervalo
    function updateRangeDisplay() {
      const range = parseInt(rangeSlider.value);
      rangeValueDisplay.textContent = `1 - ${range}`;
    }

    // Começa novo desafio
    function newChallenge() {
      locked = false;
      
      let pool = getPool();
      // Filtra números que ainda não foram usados no ciclo atual
      let remaining = pool.filter(item => !used.includes(item.jp)); 

      if (remaining.length === 0) {
        used = []; // Reseta os números usados se todos foram mostrados
        remaining = pool; // Todos os números voltam a estar disponíveis
      }
      
      current = remaining[Math.floor(Math.random() * remaining.length)];

      jpNumberEl.textContent = current.jp;
      translationEl.textContent = `${current.num}`;
      hintSymbolEl.textContent = current.tipo || "";
      feedbackEl.textContent = "";

      const correct = current.hira;
      const distractors = shuffle(pool.filter(e => e.hira !== correct))
                              .slice(0, 3)
                              .map(e => e.hira);
      
      const options = shuffle([...new Set([correct, ...distractors])]); 

      optionsEl.innerHTML = "";
      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.className = "bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-semibold py-2 px-4 rounded-md";
        btn.onclick = () => checkAnswer(opt);
        optionsEl.appendChild(btn);
      });
    }

    // Atualiza pontuação
    function updateScore() {
      scoreEl.innerHTML = `${texts[currentLang].score}: <strong>${hits}/${total}</strong>`;
    }

    // Efeito de fogos de artifício
    const canvas = document.getElementById("fireworks-canvas");
    const ctx = canvas.getContext("2d");
    let activeFireworks = []; 
    let animationFrameId = null; 

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    class Particle {
        constructor(x, y, color, velocityX, velocityY) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.radius = Math.random() * 2 + 1;
            this.velocity = {
                x: velocityX || (Math.random() - 0.5) * 8, 
                y: velocityY || (Math.random() - 0.5) * 8
            };
            this.alpha = 1;
            this.friction = 0.98;
            this.gravity = 0.1;
        }

        draw() {
            ctx.save();
            ctx.globalAlpha = this.alpha;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
            ctx.fillStyle = this.color;
            ctx.fill();
            ctx.restore();
        }

        update() {
            this.velocity.x *= this.friction;
            this.velocity.y *= this.friction;
            this.velocity.y += this.gravity;
            this.x += this.velocity.x;
            this.y += this.velocity.y;
            this.alpha -= 0.02; 
            if (this.alpha < 0) this.alpha = 0;
        }
    }

    class Firework {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.hue = Math.random() * 360; 
            this.particles = [];
            this.createExplosion();
        }

        createExplosion() {
            const numParticles = 80; 
            for (let i = 0; i < numParticles; i++) {
                const angle = Math.PI * 2 * (i / numParticles);
                const speed = Math.random() * 6 + 2; 
                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed;
                this.particles.push(new Particle(this.x, this.y, `hsl(${this.hue}, 100%, 50%)`, vx, vy));
            }
        }

        draw() {
            this.particles.forEach(particle => particle.draw());
        }

        update() {
            this.particles.forEach((particle, index) => {
                particle.update();
                if (particle.alpha <= 0) {
                    this.particles.splice(index, 1);
                }
            });
        }

        done() {
            return this.particles.length === 0;
        }
    }


    function animateFireworks() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); 
      activeFireworks.forEach(fw => {
        fw.update();
        fw.draw();
      });
      activeFireworks = activeFireworks.filter(fw => !fw.done()); 
      
      if (activeFireworks.length > 0) {
        animationFrameId = requestAnimationFrame(animateFireworks);
      } else {
        cancelAnimationFrame(animationFrameId); 
        animationFrameId = null; 
        ctx.clearRect(0, 0, canvas.width, canvas.height); 
      }
    }

    function launchFireworks() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        activeFireworks = []; 

        for (let i = 0; i < 2; i++) { 
            const x = Math.random() * window.innerWidth;
            const y = window.innerHeight * (0.3 + Math.random() * 0.4); 
            activeFireworks.push(new Firework(x, y));
        }
        animateFireworks(); 
    }

    // Função para verificar resposta
    function checkAnswer(value) {
      if (locked) return;
      locked = true;

      if (!value) return;
      total++;
      const correct = current.hira;
      if (value === correct) {
        feedbackEl.textContent = texts[currentLang].correct;
        feedbackEl.className = "text-green-600";
        hits++;
        used.push(current.jp); 

        soundCorrect.currentTime = 0;
        soundCorrect.play().catch(e => console.error("Erro ao tocar som de acerto:", e));

        launchFireworks(); 

      } else {
        feedbackEl.textContent = `${texts[currentLang].wrong} ${correct}`;
        feedbackEl.className = "text-red-600";

        soundWrong.currentTime = 0;
        soundWrong.play().catch(e => console.error("Erro ao tocar som de erro:", e));
      }
      updateScore();
      setTimeout(() => {
        locked = false; 
        newChallenge();
      }, 1500);
    }

    // Atualiza textos de acordo com idioma
    function updateLangTexts() {
      document.title = texts[currentLang].title;
      langToggleBtn.textContent = texts[currentLang].langToggle;
      darkToggleBtn.textContent = darkMode ? texts[currentLang].darkToggleActive : texts[currentLang].darkToggle;

      modeLabel.textContent = texts[currentLang].modeLabel;
      rangeLabel.textContent = texts[currentLang].rangeLabel;
      volumeLabel.textContent = texts[currentLang].volumeLabel;

      modeSelect.options[0].text = texts[currentLang].modeOptions[0];
      modeSelect.options[1].text = texts[currentLang].modeOptions[1];
      modeSelect.options[2].text = texts[currentLang].modeOptions[2];

      updateScore();
      updateRangeDisplay(); 
    }

    // Eventos

    langToggleBtn.addEventListener("click", () => {
      currentLang = currentLang === "pt" ? "en" : "pt";
      hits = 0; total = 0; used = [];
      updateLangTexts();
      newChallenge();
    });

    darkToggleBtn.addEventListener("click", () => {
      darkMode = !darkMode;
      if (darkMode) document.body.classList.add("dark");
      else document.body.classList.remove("dark");
      updateLangTexts();
    });

    modeSelect.addEventListener("change", () => {
      hits = 0; total = 0; used = [];
      updateScore();
      newChallenge();
    });

    rangeSlider.addEventListener("input", () => {
      updateRangeDisplay(); 
      hits = 0; total = 0; used = []; 
      updateScore();
      newChallenge();
    });

    volumeSlider.addEventListener("input", () => {
      const vol = parseFloat(volumeSlider.value);
      soundCorrect.volume = vol;
      soundWrong.volume = vol;
    });

    // Inicialização
    updateLangTexts();
    updateScore();
    newChallenge();
  </script>
</body>
</html>
